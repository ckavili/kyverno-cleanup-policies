---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: scale-down-inference-service
spec:
  rules:
    - name: scale-down-inference-service-if-time-greater-3h
      match:
        any:
        - resources:
            kinds:
              - Pod
            selector:
              matchLabels:
                component: "predictor"
            operations:
              - DELETE
      preconditions:
        all:
          - key: "{{ request.object.metadata.namespace }}"
            operator: AnyNotIn
            value:
              - "openshift-*" # add more namespace if needed
              - "llm-hosting"
              - "rhoai-bu-services"
              - "cert-manager*"
              - "kube-*"
              - "knative*"
              - "istio-system"
              - "image-generation"
              - "nvidia-gpu-operator"
              - "redhat-ods-*"
              - "rhods-notebooks"
              - "*-operator"
      mutate:
        targets:
        - apiVersion: serving.kserve.io/v1beta1
          kind: InferenceService
          name: "{{ request.object.metadata.labels.\"serving.kserve.io/inferenceservice\" }}"
          namespace: "{{ request.object.metadata.namespace }}"
        patchesJson6902: |-
          - op: replace
            path: /spec/predictor/maxReplicas
            value: 0
          - op: replace
            path: /spec/predictor/minReplicas
            value: 0
